<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>PokerEye Visual Test Results (D3.js)</title>
  <script src="https://d3js.org/d3.v7.min.js"></script>
  <style>
    body {
      font-family: 'Segoe UI', Arial, sans-serif;
      background: linear-gradient(120deg, #232526 0%, #414345 100%);
      color: #f3f3f3;
      margin: 0;
      padding: 0;
    }
    .container {
      max-width: 900px;
      margin: 40px auto;
      background: rgba(30,30,40,0.95);
      border-radius: 16px;
      box-shadow: 0 8px 32px rgba(0,0,0,0.25);
      padding: 32px 40px 40px 40px;
    }
    h1 {
      text-align: center;
      font-size: 2.2em;
      margin-bottom: 24px;
      letter-spacing: 1px;
      color: #ffb347;
      text-shadow: 0 2px 8px #000;
    }
    #chart {
      margin: 0 auto;
      display: block;
    }
    .d3-tooltip {
      position: absolute;
      background: #222;
      color: #ffb347;
      padding: 8px 14px;
      border-radius: 8px;
      pointer-events: none;
      font-size: 1em;
      box-shadow: 0 2px 8px #000;
      opacity: 0.95;
    }
  </style>
</head>

<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>PokerEye Visual Test Results</title>
  <script src="https://d3js.org/d3.v7.min.js"></script>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap" rel="stylesheet">
  <style>
    body {
      font-family: 'Roboto', Arial, sans-serif;
      background: linear-gradient(120deg, #232526 0%, #414345 100%);
      color: #f3f3f3;
      margin: 0;
      min-height: 100vh;
    }
    .container {
      max-width: 1000px;
      margin: 40px auto;
      background: rgba(34, 34, 34, 0.97);
      border-radius: 18px;
      box-shadow: 0 8px 32px rgba(0,0,0,0.25);
      padding: 32px 40px 40px 40px;
    }
    h1 {
      text-align: center;
      font-size: 2.5em;
      margin-bottom: 10px;
      letter-spacing: 2px;
      color: #00c3ff;
      text-shadow: 0 2px 8px #222;
    }
    .desc {
      text-align: center;
      color: #b0b0b0;
      margin-bottom: 30px;
    }
    #chart {
      width: 100%;
      height: 420px;
      margin: 0 auto 30px auto;
      display: block;
    }
    .scenario-table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 20px;
      background: #222;
      border-radius: 8px;
      overflow: hidden;
    }
    .scenario-table th, .scenario-table td {
      padding: 10px 8px;
      text-align: left;
      border-bottom: 1px solid #333;
    }
    .scenario-table th {
      background: #111;
      color: #00c3ff;
      font-weight: 700;
    }
    .scenario-table tr:last-child td {
      border-bottom: none;
    }
    .equity-bar {
      height: 18px;
      border-radius: 8px;
      background: linear-gradient(90deg, #00c3ff 0%, #ffdd00 100%);
      box-shadow: 0 2px 8px #222;
    }
    .btn-group {
      margin-bottom: 24px;
      display: flex;
      justify-content: center;
      gap: 16px;
    }
    .stat-box {
      background: #111;
      border-radius: 10px;
      padding: 18px 24px;
      margin-bottom: 18px;
      color: #ffdd00;
      font-size: 1.2em;
      box-shadow: 0 2px 8px #222;
      display: inline-block;
      min-width: 180px;
      text-align: center;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>PokerEye Test Scenarios</h1>
    <div class="desc">Panel de análisis para jugadores semi-pro: equity, EV, winrate y comparación cash/torneo</div>
    <div class="btn-group">
      <button class="btn btn-primary" id="reload-btn">Recargar Datos</button>
      <button class="btn btn-success" id="mode-btn">Modo: <span id="mode-label">Cash</span></button>
      <select class="form-select w-auto" id="player-type-filter">
        <option value="all">Todos los tipos</option>
        <option value="tight">Tight</option>
        <option value="loose">Loose</option>
        <option value="aggressive">Aggressive</option>
        <option value="passive">Passive</option>
      </select>
    </div>
    <div id="stats" class="d-flex justify-content-center gap-3"></div>
    <svg id="chart"></svg>
    <table class="scenario-table" id="scenario-table">
      <thead>
        <tr>
          <th>Escenario</th>
          <th>Tipo Jugador</th>
          <th>Equity (%)</th>
          <th>EV</th>
          <th>Barra</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>
  <script>
    let mode = 'cash';
    let filter = 'all';
    function getPlayerType(scenario) {
      if (!scenario || !scenario.actions) return 'Desconocido';
      if (scenario.name.toLowerCase().includes('tight')) return 'Tight';
      if (scenario.name.toLowerCase().includes('loose')) return 'Loose';
      if (scenario.name.toLowerCase().includes('aggressive')) return 'Aggressive';
      if (scenario.name.toLowerCase().includes('passive')) return 'Passive';
      return 'Otro';
    }

    function render(data) {
      // Filtrar por tipo de jugador
      let filtered = data;
      if (filter !== 'all') {
        filtered = data.filter(s => getPlayerType(s).toLowerCase() === filter);
      }

      // Estadísticas clave
      const avgEquity = filtered.length ? (filtered.reduce((acc,s)=>acc+(s.equity||0),0)/filtered.length) : 0;
      const maxEquity = filtered.length ? Math.max(...filtered.map(s=>s.equity||0)) : 0;
      const minEquity = filtered.length ? Math.min(...filtered.map(s=>s.equity||0)) : 0;
      const avgEV = filtered.length ? (filtered.reduce((acc,s)=>acc+(s.actions[0]?.ev||0),0)/filtered.length) : 0;

      document.getElementById('stats').innerHTML = `
        <div class="stat-box">Promedio Equity: <b>${avgEquity.toFixed(2)}%</b></div>
        <div class="stat-box">Máximo Equity: <b>${maxEquity.toFixed(2)}%</b></div>
        <div class="stat-box">Mínimo Equity: <b>${minEquity.toFixed(2)}%</b></div>
        <div class="stat-box">Promedio EV: <b>${avgEV.toFixed(2)}</b></div>
        <div class="stat-box">Modo: <b>${mode === 'cash' ? 'Cash Game' : 'Torneo'}</b></div>
      `;

      // D3 Bar Chart
      d3.select('#chart').selectAll('*').remove();
      const margin = {top: 30, right: 30, bottom: 60, left: 60};
      const width = 800 - margin.left - margin.right;
      const height = 400 - margin.top - margin.bottom;
      const svg = d3.select('#chart')
        .attr('width', width + margin.left + margin.right)
        .attr('height', height + margin.top + margin.bottom)
        .append('g')
        .attr('transform', `translate(${margin.left},${margin.top})`);

      const x = d3.scaleBand()
        .domain(filtered.map(d => d.name))
        .range([0, width])
        .padding(0.2);
      const y = d3.scaleLinear()
        .domain([0, 100])
        .range([height, 0]);

      svg.append('g')
        .attr('transform', `translate(0,${height})`)
        .call(d3.axisBottom(x))
        .selectAll('text')
        .attr('transform', 'rotate(-25)')
        .style('text-anchor', 'end')
        .style('font-size', '1em')
        .style('fill', '#00c3ff');

      svg.append('g')
        .call(d3.axisLeft(y))
        .selectAll('text')
        .style('font-size', '1em')
        .style('fill', '#ffdd00');

      svg.selectAll('rect')
        .data(filtered)
        .enter()
        .append('rect')
        .attr('x', d => x(d.name))
        .attr('y', d => y(d.equity || 0))
        .attr('width', x.bandwidth())
        .attr('height', d => height - y(d.equity || 0))
        .attr('fill', 'url(#bar-gradient)');

      // Gradient for bars
      svg.append('defs').append('linearGradient')
        .attr('id', 'bar-gradient')
        .attr('x1', '0%').attr('y1', '0%')
        .attr('x2', '100%').attr('y2', '0%')
        .selectAll('stop')
        .data([
          {offset: '0%', color: '#00c3ff'},
          {offset: '100%', color: '#ffdd00'}
        ])
        .enter()
        .append('stop')
        .attr('offset', d => d.offset)
        .attr('stop-color', d => d.color);

      // Table with equity bars and stats
      const tbody = document.querySelector('#scenario-table tbody');
      tbody.innerHTML = '';
      filtered.forEach(s => {
        const playerType = getPlayerType(s);
        const ev = s.actions[0]?.ev !== undefined ? s.actions[0].ev.toFixed(2) : '-';
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${s.name}</td>
          <td>${playerType}</td>
          <td>${s.equity ? s.equity.toFixed(2) : '0.00'}</td>
          <td>${ev}</td>
          <td><div class="equity-bar" style="width:${s.equity ? s.equity : 0}%;"></div></td>
        `;
        tbody.appendChild(tr);
      });
    }

    function loadData() {
      fetch('/results')
        .then(res => res.json())
        .then(data => {
          render(data);
        });
    }

    document.getElementById('reload-btn').onclick = () => loadData();
    document.getElementById('mode-btn').onclick = () => {
      mode = mode === 'cash' ? 'tournament' : 'cash';
      document.getElementById('mode-label').textContent = mode === 'cash' ? 'Cash' : 'Torneo';
      loadData();
    };
    document.getElementById('player-type-filter').onchange = (e) => {
      filter = e.target.value;
      loadData();
    };

    // Inicializar
    loadData();
  </script>
</body>
</html>
          .attr('width', d => x(d.equity || 0))
          .attr('fill', d => color(d.equity || 0))
          .on('mousemove', function(event, d) {
            tooltip.style('left', (event.pageX + 10) + 'px')
                   .style('top', (event.pageY - 20) + 'px')
                   .style('opacity', 1)
                   .html(`<strong>${d.name}</strong><br>Equity: <span style='color:#fff'>${d.equity?.toFixed(2) ?? 0}%</span>`);
          })
          .on('mouseout', function() {
            tooltip.style('opacity', 0);
          });

        // Y axis
        g.append('g')
          .call(d3.axisLeft(y))
          .selectAll('text')
          .style('font-size', '1.1em')
          .style('fill', '#ffb347');
        // X axis
        g.append('g')
          .attr('transform', `translate(0,${height})`)
          .call(d3.axisBottom(x).ticks(10).tickFormat(d => d + '%'))
          .selectAll('text')
          .style('font-size', '1.1em')
          .style('fill', '#ffb347');
        // X axis label
        svg.append('text')
          .attr('x', margin.left + width/2)
          .attr('y', margin.top + height + 40)
          .attr('text-anchor', 'middle')
          .attr('font-size', '1.3em')
          .attr('fill', '#ffb347')
          .text('Equity (%)');

        // Tooltip
        const tooltip = d3.select('body').append('div')
          .attr('class', 'd3-tooltip')
          .style('opacity', 0);
      });
  </script>
</body>
</html>
